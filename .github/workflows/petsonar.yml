name: Petclinic CI/CD SonarQube

on:
  push:
    branches:
      - master
      - dev
      - stage
  workflow_dispatch:
    inputs:
      docker_tag:
        description: 'Docker image tag (e.g. latest, v1.0)'
        required: true
        default: 'latest'
jobs:
  build-and-push:
    runs-on: ubuntu-latest
    environment: dev
    permissions:
      contents: read
      packages: write

    steps:
      # ğŸ§± Step 1: Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # ğŸ§© Step 2: Install yq for YAML parsing
      - name: Install yq
        run: |
          echo "ğŸ“¦ Installing yq..."
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          yq --version

      # ğŸ§¾ Step 3: Load variables from vars/all.yml
      - name: Load tool versions and build variables
        run: |
          CONFIG_FILE="vars/all.yml"
          echo "ğŸ“¦ Loading variables from $CONFIG_FILE ..."

          if [ ! -f "$CONFIG_FILE" ]; then
            echo "âŒ File not found: $CONFIG_FILE"
            exit 1
          fi

          if ! yq eval '.' "$CONFIG_FILE" >/dev/null 2>&1; then
            echo "âŒ Invalid YAML syntax detected!"
            exit 1
          fi

          # Export YAML to environment variables
          yq eval '. as $in | to_entries | .[] | "\(.key)=\(.value)"' "$CONFIG_FILE" \
            | grep -E '^[A-Za-z0-9_]+=' > vars.env || true

          cat vars.env >> $GITHUB_ENV
          echo "âœ… Environment variables loaded successfully."

      # â˜• Step 4: Set up Java dynamically
      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: maven

      # ğŸ§ª Step 5: Display versions
      - name: Verify tool versions
        run: |
          echo "â˜• Java version:"
          java -version
          echo "ğŸ”§ Maven version:"
          mvn -v

      # ğŸ§± Step 6: Build the application (Skip HTTP + Checkstyle validation)
      - name: Build with Maven
        run: |
            echo "ğŸš€ Building project for environment: $ENVIRONMENT"
            mvn clean install -Pci-build \
                -Dcheckstyle.skip=true \
                -Dspring-javaformat.skip=true \
                -DskipTests \
                -s ./settings.xml
            ls -ltra target/*

      # ğŸ” Step 7: SonarQube Analysis
      - name: SonarQube Scan
        env:
            SONAR_HOST_URL: ${{ env.SONAR_HOST_URL }}
            SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
            echo "ğŸ” Running SonarQube analysis..."
            mvn verify sonar:sonar \
                -DskipTests \
                -Dcheckstyle.skip=true \
                -Dspring-javaformat.skip=true \
                -Dnohttp.check.skip=true \
                -Dsonar.projectBaseDir=. \
                -Dsonar.host.url=$SONAR_HOST_URL \
                -Dsonar.login=$SONAR_TOKEN

      # ğŸ³ Step 8: Docker login
      - name: Docker Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      # ğŸ§© Step 9: Build and push Docker image
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v6
        with:
          context: ${{ env.PACKAGE_DIR }}
          push: true
          tags: ${{ env.DOCKER_IMAGE }}:${{ github.event.inputs.docker_tag }}

      # ğŸ§¹ Step 10: Cleanup workspace
      - name: Cleanup workspace
        run: |
          echo "ğŸ§¹ Cleaning up workspace..."
          sudo rm -rf *

      # âœ… Step 11: Success message
      - name: Success message
        if: ${{ success() }}
        run: |
          echo "âœ… Successfully built and pushed image for $ENVIRONMENT"
          echo "Image: ${{ env.DOCKER_IMAGE }}:${{ github.event.inputs.docker_tag }}"

      # âŒ Step 12: Failure message
      - name: Failure message
        if: ${{ failure() }}
        run: echo "âŒ Build failed. Check logs for details."