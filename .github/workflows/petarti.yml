name: Petclinic CI Jfrog

on:
  push:
    branches:
      - master
      - dev
      - stage
  workflow_dispatch:
    inputs:
      docker_tag:
        description: 'Docker image tag (e.g. latest, v1.0)'
        required: true
        default: 'latest'

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    environment: dev
    permissions:
      contents: read
      packages: write

    steps:
      # üß± Step 1: Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install yq
        run: |
            echo "üì¶ Installing yq..."
            sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
            sudo chmod +x /usr/local/bin/yq
            yq --version

      - name: Load tool versions and build variables
        run: |
          CONFIG_FILE="vars/all.yml"
          echo "üì¶ Loading variables from $CONFIG_FILE ..."

          if [ ! -f "$CONFIG_FILE" ]; then
            echo "‚ùå File not found: $CONFIG_FILE"
            ls -R
            exit 1
          fi

          echo "üîç YAML content:"
          cat "$CONFIG_FILE"
          echo "========================"

          if ! yq eval '.' "$CONFIG_FILE" >/dev/null 2>&1; then
            echo "‚ùå Invalid YAML syntax detected!"
            exit 1
          fi

          yq eval '. as $in | to_entries | .[] | "\(.key)=\(.value)"' "$CONFIG_FILE" \
            | grep -E '^[A-Za-z0-9_]+=' > vars.env || true

          echo "‚úÖ Processed variables:"
          cat vars.env || true

          if [ ! -s vars.env ]; then
            echo "‚ùå No valid variables found ‚Äî check YAML keys."
            exit 1
          fi

          cat vars.env >> $GITHUB_ENV
          echo "‚úÖ Environment variables loaded successfully."

      # ‚òï Step 4: Set up Java dynamically
      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: maven

      # üß™ Step 6: Display versions (optional sanity check)
      - name: Verify tool versions
        run: |
          echo "‚òï Java version:"
          java -version
          echo "üîß Maven version:"
          mvn -v

      # üß± Step 7: Build the application
      - name: Build with Maven
        run: |
          echo "üöÄ Building project for environment: $ENVIRONMENT"
          mvn clean install -Dnohttp.check.skip=true -Dcheckstyle.skip=true -Dspring-javaformat.skip=true -DskipTests -s ./settings.xml


    # ===================================
    # üîß Allow HTTP (insecure) registry
    # ===================================
      - name: Configure Docker insecure registry
        run: |
            echo '{
            "insecure-registries": ["${{ env.ARTIFACTORY_URL }}"]
            }' | sudo tee /etc/docker/daemon.json
            sudo systemctl restart docker
            
      # ================================
      # üîê JFROG ARTIFACTORY LOGIN
      # ================================
      - name: Artifactory Docker Login
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ARTIFACTORY_URL }}
          username: ${{ secrets.ARTIFACTORY_USERNAME }}
          password: ${{ secrets.ARTIFACTORY_TOKEN  }}

      # ========================================
      # üê≥ Build & Push Image to Artifactory
      # ========================================
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v6
        with:
          context: ${{ env.PACKAGE_DIR }}
          push: true
          tags: |
            ${{ env.ARTIFACTORY_URL }}/${{ env.ARTIFACTORY_REPO }}/${{ env.DOCKER_IMAGE }}:${{ github.event.inputs.docker_tag }}

      # üßπ Step 10: Cleanup
      - name: Cleanup workspace
        run: |
          echo "üßπ Cleaning up workspace..."
          sudo rm -rf *

      # ‚úÖ Step 11: Success message
      - name: Success message
        if: ${{ success() }}
        run: |
          echo "‚úÖ Successfully built and pushed image for $ENVIRONMENT"
          echo "Image: ${{ env.DOCKER_IMAGE }}:${{ github.event.inputs.docker_tag }}"

      # ‚ùå Step 12: Failure message
      - name: Failure message
        if: ${{ failure() }}
        run: echo "‚ùå Build failed. Check logs for details."